---
title: "Predicting Childhood Mortality Based on Health and Socio-Economic Indicators"
author: "Aicha Sidiya, Hanin Alzaher, Razan Almahdi"
date: "2023-06-01"
output:
  word_document: default
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r loading libraries}
#loading libraries
library(tidyverse)
library(dplyr)
library(readr)
library(caret)
library(RANN)
library(skimr)
library(ggplot2)
library(stringr)
library(gbm)
```

```{r loading data}
#loading the data set
mortality_rate <- read.csv('data/Mortality rate, under-5 (per 1,000 live births).csv')
health_expenditure <- read.csv('data/Current health expenditure per capita (current US$).csv')
health_expenditure_per <- read.csv('data/Current health expenditure (% of GDP).csv')
education_expenditure <- read.csv('data/Current education expenditure, total (%).csv')
literacy_rate <- read.csv('data/literacy_rate.csv')
domestic_health_expenditure <- read.csv('data/Domestic private health expenditure (% of current health expenditure).csv')
economic_inequality <- read.csv('data/economic-inequality-gini-index.csv')
water_invest <- read.csv('data/Investment in water and sanitation (current US$).csv')
vacinnation <- read.csv('data/vaccination-coverage-by-income-in.csv')
water_productivity <- read.csv('data/Water productivity_per cubic meter of total freshwater withdrawal.csv')
healthcare_access <- read.csv('data/healthcare-access-and-quality-index.csv')
```

```{r preprocess1}
#selecting from year 2000 till 2020
mortality_rate <- select(mortality_rate, country, 'X2000':'X2020')
health_expenditure <- select(health_expenditure, country, 'X2000':'X2020')
health_expenditure_per<- select(health_expenditure_per, country, 'X2000':'X2020')
literacy_rate <- select(literacy_rate, country, 'X2000':'X2020')
education_expenditure <- select(education_expenditure, country, 'X2000':'X2020')
water_invest <- select(water_invest, country, 'X2000':'X2020')
water_productivity <- select(water_productivity, country, 'X2000':'X2020')
domestic_health_expenditure <- select(domestic_health_expenditure, country, 'X2000':'X2020')
economic_inequality <- filter(economic_inequality, year >= 2000)
vacinnation <- filter(vacinnation, year >= 2000)
healthcare_access <- filter(healthcare_access, year >= 2000)
```

```{r preprocess2}
#renaming columns
mortality_rate_years <- select (mortality_rate, 'X2000':'X2020')
names(mortality_rate_years) <- str_sub(names(mortality_rate_years),2)
mortality_rate <- select(mortality_rate, country)
mortality_rate <- bind_cols(mortality_rate,mortality_rate_years)

health_expenditure_years <- select (health_expenditure, 'X2000':'X2020')
names(health_expenditure_years) <- str_sub(names(health_expenditure_years),2)
health_expenditure <- select(health_expenditure, country)
health_expenditure <- bind_cols(health_expenditure, health_expenditure_years)

health_expenditure_per_years <- select (health_expenditure_per, 'X2000':'X2020')
names(health_expenditure_per_years) <- str_sub(names(health_expenditure_per_years),2)
health_expenditure_per <- select(health_expenditure_per, country)
health_expenditure_per <- bind_cols(health_expenditure_per, health_expenditure_per_years)

education_expenditure_years <- select (education_expenditure, 'X2000':'X2020')
names(education_expenditure_years) <- str_sub(names(education_expenditure_years),2)
education_expenditure <- select(education_expenditure, country)
education_expenditure <- bind_cols(education_expenditure, education_expenditure_years)

domestic_health_expenditure_years <- select (domestic_health_expenditure, 'X2000':'X2020')
names(domestic_health_expenditure_years) <- str_sub(names(domestic_health_expenditure_years),2)
domestic_health_expenditure <- select(domestic_health_expenditure, country)
domestic_health_expenditure <- bind_cols(domestic_health_expenditure, domestic_health_expenditure_years)

literacy_rate_years <- select (literacy_rate, 'X2000':'X2020')
names(literacy_rate_years) <- str_sub(names(literacy_rate_years),2)
literacy_rate <- select(literacy_rate, country)
literacy_rate <- bind_cols(literacy_rate, literacy_rate_years)

water_invest_years <- select (water_invest, 'X2000':'X2020')
names(water_invest_years) <- str_sub(names(water_invest_years),2)
water_invest <- select(water_invest, country)
water_invest <- bind_cols(water_invest, water_invest_years)

water_productivity_years <- select (water_productivity, 'X2000':'X2020')
names(water_productivity_years) <- str_sub(names(water_productivity_years),2)
water_productivity <- select(water_productivity, country)
water_productivity <- bind_cols(water_productivity, water_productivity_years)
```

```{r preprocess3}
#pivoting tables
mortality_rate1 <- pivot_longer(mortality_rate, cols="2000":"2020",
                                 names_to = "year",
                                 values_to = "mortality_rate")
health_expenditure1 <- pivot_longer(health_expenditure, cols="2000":"2020",
                                 names_to = "year",
                                 values_to = "health_expenditure")
health_expenditure_per1 <- pivot_longer(health_expenditure_per, cols="2000":"2020",
                                 names_to = "year",
                                 values_to = "health_expenditure_per")
education_expenditure1 <- pivot_longer(education_expenditure, cols="2000":"2020",
                                 names_to = "year",
                                 values_to = "education_expenditure")
domestic_health_expenditure1 <- pivot_longer(domestic_health_expenditure, cols="2000":"2020",
                                 names_to = "year",
                                 values_to = "domestic_health_expenditure")
literacy_rate1 <- pivot_longer(literacy_rate, cols="2000":"2020",
                                 names_to = "year",
                                 values_to = "literacy_rate")
water_invest1 <- pivot_longer(water_invest, cols="2000":"2020",
                                 names_to = "year",
                                 values_to = "water_invest")
water_productivity1 <- pivot_longer(water_productivity, cols="2000":"2020",
                                 names_to = "year",
                                 values_to = "water_productivity")
```


```{r preprocess4}
#merging data
merge_data <- merge(mortality_rate1, health_expenditure1, by = c("country", "year"), all = TRUE)
merge_data <- merge(merge_data, health_expenditure_per1, by = c("country", "year"), all = TRUE)
merge_data <- merge(merge_data, education_expenditure1, by = c("country", "year"), all = TRUE)
merge_data <- merge(merge_data, domestic_health_expenditure1, by = c("country", "year"), all = TRUE)
merge_data <- merge(merge_data, literacy_rate1, by = c("country", "year"), all = TRUE)
merge_data <- merge(merge_data, water_invest1, by = c("country", "year"), all = TRUE)
merge_data <- merge(merge_data, water_productivity1, by = c("country", "year"), all = TRUE)
merge_data <- merge(merge_data, vacinnation, by = c("country", "year"), all = TRUE)
```

```{r data overview}
glimpse(merge_data)
```

```{r data overview2}
skimmed <- skim_to_wide(merge_data)
skimmed
```

```{r preprocess5}
#including counties of the world
all_countries <- c("Afghanistan", "Albania", "Algeria", "Andorra", "Angola", "Antigua and Barbuda",
    "Argentina", "Armenia", "Australia", "Austria", "Azerbaijan", "Bahamas", "Bahrain",
    "Bangladesh", "Barbados", "Belarus", "Belgium", "Belize", "Benin", "Bhutan",
    "Bolivia", "Bosnia and Herzegovina", "Botswana", "Brazil", "Brunei", "Bulgaria",
    "Burkina Faso", "Burundi", "Cabo Verde", "Cambodia", "Cameroon", "Canada",
    "Central African Republic", "Chad", "Chile", "China", "Colombia", "Comoros",
    "Congo", "Costa Rica", "Croatia", "Cuba", "Cyprus", "Czech Republic", "Denmark",
    "Djibouti", "Dominica", "Dominican Republic", "East Timor", "Ecuador", "Egypt",
    "El Salvador", "Equatorial Guinea", "Eritrea", "Estonia", "Eswatini", "Ethiopia",
    "Fiji", "Finland", "France", "Gabon", "Gambia", "Georgia", "Germany", "Ghana",
    "Greece", "Grenada", "Guatemala", "Guinea", "Guinea-Bissau", "Guyana", "Haiti",
    "Honduras", "Hungary", "Iceland", "India", "Indonesia", "Iran", "Iraq", "Ireland",
    "Israel", "Italy", "Jamaica", "Japan", "Jordan", "Kazakhstan", "Kenya", "Kiribati",
    "Korea, North", "Korea, South", "Kosovo", "Kuwait", "Kyrgyzstan", "Laos", "Latvia",
    "Lebanon", "Lesotho", "Liberia", "Libya", "Liechtenstein", "Lithuania", "Luxembourg",
    "Madagascar", "Malawi", "Malaysia", "Maldives", "Mali", "Malta", "Marshall Islands",
    "Mauritania", "Mauritius", "Mexico", "Micronesia", "Moldova", "Monaco", "Mongolia",
    "Montenegro", "Morocco", "Mozambique", "Myanmar", "Namibia", "Nauru", "Nepal",
    "Netherlands", "New Zealand", "Nicaragua", "Niger", "Nigeria", "North Macedonia",
    "Norway", "Oman", "Pakistan", "Palau", "Panama", "Papua New Guinea", "Paraguay",
    "Peru", "Philippines", "Poland", "Portugal", "Qatar", "Romania", "Russia", "Rwanda",
    "Saint Kitts and Nevis", "Saint Lucia", "Saint Vincent and the Grenadines", "Samoa",
    "San Marino", "Sao Tome and Principe", "Saudi Arabia", "Senegal", "Serbia", "Seychelles",
    "Sierra Leone", "Singapore", "Slovakia", "Slovenia", "Solomon Islands", "Somalia",
    "South Africa", "South Sudan", "Spain", "Sri Lanka", "Sudan", "Suriname", "Sweden",
    "Switzerland", "Syria", "Taiwan", "Tajikistan", "Tanzania", "Thailand", "Togo",
    "Tonga", "Trinidad and Tobago", "Tunisia", "Turkey", "Turkmenistan", "Tuvalu",
    "Uganda", "Ukraine", "United Arab Emirates", "United Kingdom", "United States",
    "Uruguay", "Uzbekistan", "Vanuatu", "Vatican City", "Venezuela", "Vietnam",
    "Yemen", "Zambia", "Zimbabwe")

merge_data <- subset(merge_data, country %in% all_countries)
```

```{r save1}
#saving the final data
write.csv(merge_data, "data/my_data.csv")
```

```{r preprocess6}
#remove rows with all na
filtered_data <- merge_data %>%
  select(-country, -year) %>%
  filter(rowSums(is.na(.)) != ncol(.))

```

```{r impute}
# Create the knn imputation model on the training data
preProcess_missingdata_model <- preProcess(filtered_data, method='knnImpute')
preProcess_missingdata_model

# Use the imputation model to predict the values of missing data points
my_data_imputed <- predict(preProcess_missingdata_model, newdata = filtered_data)
anyNA(my_data_imputed)

```

```{r save2}
#saving the imputed data
write.csv(my_data_imputed, "data/my_data_imputed.csv")
```

What is the trend and pattern of the average mortality rate over the years and are there any significant changes or fluctuations observed?
```{r avg mortality}
# Impute missing values in the mortality_rate column using mean
imputed_data_mean <- merge_data %>%
  mutate(mortality_rate = replace_na(mortality_rate, mean(mortality_rate, na.rm = TRUE)))

write.csv(imputed_data_mean, "data/imputed_data_mean.csv")

# Aggregate data by year and calculate the average mortality rate
avg_mortality <- aggregate(mortality_rate ~ year, data = imputed_data_mean, FUN = mean)

# Create the line plot
ggplot(avg_mortality, aes(x = year, y = mortality_rate, group = 1)) +
  geom_line() +
  xlab("Year") +
  ylab("Average Mortality Rate") +
  ggtitle("Average Mortality Rate over Years")
```
The plot depicts the average mortality rate over a range of years. The x-axis represents the years, while the y-axis represents the average mortality rate. The plot reveals a trend of the average mortality rate over time. In the earlier years, the average mortality rate was relatively high, gradually declining in subsequent years. However, there was a slight increase in the average mortality rate in 2018. Also, the plot shows a significant and noticeable increase in the average mortality rate in 2020. The sudden surge in the average mortality rate suggests a critical event or influential factor that impacted the population's health during this period.


What is the relationship between Mortality Rate and Health Expenditure?
```{r mprtality rate vs health}
ggplot(data=my_data_imputed,mapping= aes(x = health_expenditure, y = mortality_rate)) +
  geom_point(color="#361576") +
  xlab("Health Expenditure") +
  ylab("Mortality Rate") +
  ggtitle("Mortality Rate vs. Health Expenditure")
```
The plot showcases the relationship between Mortality Rate and Health Expenditure. The x-axis represents Health Expenditure, while the y-axis represents Mortality Rate. The plot demonstrates the varying levels of Mortality Rate observed at different levels of Health Expenditure. 

Upon closer examination, it becomes apparent that there is an inverse relationship between Mortality Rate and Health Expenditure. As Health Expenditure increases, Mortality Rate tends to decrease, suggesting a potential link between higher healthcare investment and improved health outcomes. However, it is worth noting that this relationship may not be entirely linear, as there are instances where the Mortality Rate remains relatively high despite higher Health Expenditure.


How does Literacy Rate affects Mortality Rate?
```{r mortality rate vs expenditure}
ggplot(data = my_data_imputed, mapping=aes(x = literacy_rate, y = mortality_rate)) +
  geom_point(color="#361576") +
  xlab("Literacy Rate") +
  ylab("Mortality Rate") +
  ggtitle("Distribution of Mortality Rate across Literacy Rates")
```
The plot illustrates the distribution of Mortality Rate across different levels of Literacy Rates. The x-axis represents the Literacy Rates, while the y-axis represents the Mortality Rate.

Examining the plot, it is evident that there is a discernible pattern in the distribution of Mortality Rate with respect to Literacy Rates. As Literacy Rates increase, there is a tendency for the Mortality Rate to decrease. This suggests a potential correlation between higher literacy levels and lower Mortality Rates, indicating that education and literacy may play a role in improving overall health outcomes.

However, it is important to note that the relationship between Mortality Rate and Literacy Rate may not be solely determined by literacy itself. Other confounding factors such as healthcare access, socioeconomic status, and healthcare utilization may also contribute to the observed distribution.


What is the effect of Education Expenditure on Mortality Rate?
```{r mortality rate vs education}
ggplot(data=my_data_imputed,mapping= aes(x = education_expenditure, y = mortality_rate)) +
  geom_smooth() +
  xlab("Education Expenditure") +
  ylab("Mortality Rate") +
  ggtitle("Effect of Education Expenditure on Mortality Rate")
```
The plot visually represents the relationship between Education Expenditure and Mortality Rate. The x-axis represents Education Expenditure, while the y-axis represents Mortality Rate.

Upon examination of the plot, it is evident that there is an observable pattern indicating the effect of Education Expenditure on Mortality Rate. As Education Expenditure increases, there is a corresponding decrease in Mortality Rate. This suggests a potentially significant and meaningful relationship between higher investments in education and improved health outcomes.

The plot demonstrates that allocating resources towards education expenditure may play a crucial role in reducing Mortality Rate. However, it is important to note that this relationship may not be solely determined by education expenditure itself. As we observe the significant increase of the mortality rate, other factors such as healthcare infrastructure, socioeconomic conditions, and healthcare accessibility might also influence the observed relationship.



What is the relationship between Water Productivity and Mortality Rate?
```{r}
ggplot(data=my_data_imputed,mapping =  aes(x = water_productivity, y = mortality_rate)) +
  geom_point(color = "#361576") +
  xlab(" Water Productivity") +
  ylab("Mortality Rate") +
  ggtitle("Relationship between Water Productivity and Mortality Rate") 
```
The plot visually represents the relationship between Water Productivity and Mortality Rate. The x-axis represents Water Productivity, while the y-axis represents Mortality Rate.

Upon examining the plot, it becomes apparent that there is a discernible pattern suggesting a relationship between Water Productivity and Mortality Rate. As Water Productivity increases, there is a tendency for the Mortality Rate to decrease. This implies that higher efficiency and productivity in water usage may be associated with improved health outcomes and reduced Mortality Rates.



What is the relationship between Immunazation and Mortality Rate?
```{r}
ggplot(data= my_data_imputed, mapping = aes(x = immunazation,y = mortality_rate))+
  geom_bar(stat = "summary", fun = "mean",color="#361576")+
  xlab("Immunazation") +
  ylab("Mortality Rate") +
  ggtitle("Relationship between Immunazation and Mortality Rate")
```
The plot visually represents the relationship between Immunization and Mortality Rate. The x-axis represents the level of Immunization, while the y-axis represents the Mortality Rate.

Upon examining the plot, a clear pattern emerges, indicating a relationship between Immunization and Mortality Rate. As the level of Immunization increases, there is a corresponding decrease in the Mortality Rate. This suggests that higher rates of Immunization may be associated with lower Mortality Rates, highlighting the potential protective effect of immunization against preventable diseases.

```{r trainig1}
# Store X and Y for later use.
X = my_data_imputed[, 2:10]
y = my_data_imputed$mortality_rate
```


```{r split-train-test}
# Set the seed for reproducibility
set.seed(123)

#train test split 
train_indices <- createDataPartition(y, p = 0.8, list = FALSE)
X_train <- X[train_indices,]
y_train <- y[train_indices]
X_test <- X[-train_indices,]
y_test <- y[-train_indices]

```

```{r linear regression}
# Create and fit the linear regression model
model_LR <- train(X_train, y_train, method = "lm")

# Make predictions on the test set
y_pred_LR <- predict(model_LR, X_test)

# Evaluate the model using mean squared error
mse_LR <- mean((y_test - y_pred_LR)^2)

# Calculate R-squared
r2_LR <- cor(y_pred_LR, y_test)^2

```

```{r decison tree}
# Create and fit the decison tree model
model_tree <- train(X_train, y_train, method = "rpart")

# Make predictions on the test set
y_pred_tree <- predict(model_tree, X_test)

# Evaluate the model using mean squared error
mse_tree <- mean((y_test - y_pred_tree)^2)

# Calculate R-squared
r2_tree <- cor(y_pred_tree, y_test)^2
```

```{r gradiant boost}
# Create and fit the gradiant boost model
model_gbm <- train(X_train, y_train, method = "gbm")

# Make predictions on the test set
y_pred_gbm <- predict(model_gbm, X_test)

# Evaluate the model using mean squared error
mse_gbm <- mean((y_test - y_pred_gbm)^2)

# Calculate R-squared
r2_gbm <- cor(y_pred_gbm, y_test)^2
```

```{r XGBoost}
# Create and fit the XGBoost model
model_xgb <- train(X_train, y_train, method = "xgbTree")

# Make predictions on the test set
y_pred_xgb <- predict(model_xgb, X_test)

# Evaluate the model using mean squared error
mse_xgb <- mean((y_test - y_pred_xgb)^2)

# Calculate R-squared
r2_xgb <- cor(y_pred_xgb, y_test)^2
```

```{r SVM}
# Create and fit the SVM model
model_svm <- train(X_train, y_train, method = "svmRadial")

# Make predictions on the test set
y_pred_svm <- predict(model_svm, X_test)

# Evaluate the model using mean squared error
mse_svm <- mean((y_test - y_pred_svm)^2)

# Calculate R-squared
r2_svm <- cor(y_pred_xgb, y_test)^2
```

```{r compare}
#create table to compare models
metrics_df <- data.frame(Model = c("Linear Regression", "Decision Tree", "GBM", "XGBoost", "SVM"),
                         RMSE = c(mse_LR, mse_tree, mse_gbm, mse_xgb, mse_svm),
                         R_squared = c(r2_LR, r2_tree, r2_gbm, r2_xgb, r2_svm))

# Print the table
print(metrics_df)
```

```{r linear regression2}
#printing feature table for linear regression model
feature_importance_LR <- varImp(model_LR)
print(feature_importance_LR)
```

```{r decision tree2}
#printing feature table for decision tree model
feature_importance_tree <- varImp(model_tree)
print(feature_importance_tree)
```
```{r gradient boost2}
#printing feature table for gradient boost  model
feature_importance_gbm <- varImp(model_gbm)
print(feature_importance_gbm)
```

```{r  XGBoost2}
#printing feature table for XGBoost  model
feature_importance_xgb <- varImp(model_xgb)
print(feature_importance_xgb)
```

```{r SVM2}
#printing feature table for SVM  model
feature_importance_svm <- varImp(model_svm)
print(feature_importance_svm)
```

